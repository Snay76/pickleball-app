<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pickleball</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .hidden { display: none; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 16px; max-width: 760px; }
    label { display:block; margin-top: 10px; font-weight: 600; }
    input, select { padding: 8px; width: min(420px, 100%); }
    button { padding: 8px 12px; margin-top: 10px; cursor: pointer; }
    #status, #appStatus, #debug { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .muted { color: #666; }
    .list { margin-top: 12px; padding-left: 18px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; margin-left:8px; }
    .ok { color: #0a7a2f; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }
    .top { font-size: 20px; font-weight: 800; color: red; margin-bottom: 8px; }
  </style>
</head>

<body>
  <div class="top">VERSION ROUGE: 2026-01-21-APP-001</div>

  <h1>Pickleball</h1>

  <!-- ===== LOGIN ===== -->
  <div id="loginSection" class="card">
    <h2>Connexion</h2>

    <label for="email">Courriel</label>
    <input id="email" type="email" placeholder="nom@exemple.com" autocomplete="email" required />
    <button id="loginBtn" type="button">Recevoir un lien</button>

    <p id="status" aria-live="polite"></p>
    <p class="muted">Après avoir cliqué le lien reçu par courriel, tu reviens ici et l’app s’ouvre.</p>
  </div>

  <!-- ===== APP ===== -->
  <div id="appSection" class="card hidden">
    <h2>Application</h2>
    <p>Connecté : <strong id="userEmail">(chargement…)</strong> <span id="authPill" class="pill">auth</span></p>
    <button id="logoutBtn" type="button">Se déconnecter</button>
    <p id="appStatus"></p>

    <hr />

    <!-- Players -->
    <h3>Joueurs</h3>
    <div class="row">
      <div>
        <label for="playerName">Nom du joueur</label>
        <input id="playerName" type="text" placeholder="Ex: Marc" />
        <button id="addPlayerBtn" type="button">Ajouter joueur</button>
      </div>
    </div>
    <ul id="playersList" class="list"></ul>

    <hr />

    <!-- Matches -->
    <h3>Matchs</h3>
    <div class="row">
      <div>
        <label for="court">Terrain</label>
        <input id="court" type="number" min="1" step="1" value="1" />
      </div>
      <div>
        <label for="statusMatch">Statut</label>
        <select id="statusMatch">
          <option value="open">open</option>
          <option value="locked">locked</option>
          <option value="done">done</option>
        </select>
      </div>
      <div>
        <button id="createMatchBtn" type="button">Créer match</button>
      </div>
    </div>
    <ul id="matchesList" class="list"></ul>

    <hr />
    <button id="toggleDebugBtn" type="button">Afficher/Masquer debug</button>
    <pre id="debug" class="hidden"></pre>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://cehqaxtcfmgjajmmcccz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlaHFheHRjZm1namFqbW1jY2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NTQ1OTUsImV4cCI6MjA4NDUzMDU5NX0.U0IiTLx1_Vd4D8WBkhkO8KOrl3w_ftbPtcIWs_n1KmA";

    // ====== DOM ======
    const loginSection = document.getElementById("loginSection");
    const appSection   = document.getElementById("appSection");
    const statusEl     = document.getElementById("status");
    const appStatusEl  = document.getElementById("appStatus");
    const debugEl      = document.getElementById("debug");

    const emailEl      = document.getElementById("email");
    const loginBtn     = document.getElementById("loginBtn");
    const logoutBtn    = document.getElementById("logoutBtn");
    const userEmailEl  = document.getElementById("userEmail");
    const authPillEl   = document.getElementById("authPill");

    const playerNameEl = document.getElementById("playerName");
    const addPlayerBtn = document.getElementById("addPlayerBtn");
    const playersList  = document.getElementById("playersList");

    const courtEl      = document.getElementById("court");
    const statusMatchEl= document.getElementById("statusMatch");
    const createMatchBtn = document.getElementById("createMatchBtn");
    const matchesList  = document.getElementById("matchesList");

    const toggleDebugBtn = document.getElementById("toggleDebugBtn");

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setAppStatus(msg) { appStatusEl.textContent = msg || ""; }
    function logDebug(msg) {
      debugEl.textContent = (debugEl.textContent ? debugEl.textContent + "\n" : "") + msg;
    }

    function showLogin(msg) {
      appSection.classList.add("hidden");
      loginSection.classList.remove("hidden");
      if (msg) setStatus(msg);
    }

    function showApp() {
      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      setStatus("");
    }

    // ====== TOKEN STORAGE ======
    const LS_ACCESS = "pb_access_token";
    function saveAccessToken(token) { localStorage.setItem(LS_ACCESS, token); }
    function getAccessToken() { return localStorage.getItem(LS_ACCESS); }
    function clearTokens() { localStorage.removeItem(LS_ACCESS); }

    // ====== MAGIC LINK PARSE ======
    function parseHashParams() {
      const hash = window.location.hash?.startsWith("#") ? window.location.hash.slice(1) : "";
      if (!hash) return null;
      const params = new URLSearchParams(hash);
      return {
        access_token: params.get("access_token"),
        error: params.get("error"),
        error_description: params.get("error_description"),
        raw: hash
      };
    }

    // ====== LOW-LEVEL FETCH ======
    async function apiFetch(path, { method="GET", headers={}, body=null } = {}) {
      const token = getAccessToken();
      const url = `${SUPABASE_URL}${path}`;

      const finalHeaders = {
        apikey: SUPABASE_ANON_KEY,
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        ...headers
      };

      const opts = { method, headers: finalHeaders };
      if (body !== null) opts.body = body;

      let r, text;
      try {
        r = await fetch(url, opts);
        text = await r.text();
      } catch (e) {
        throw new Error(`FETCH FAILED: ${e?.message || e}`);
      }

      if (!r.ok) {
        throw new Error(`${method} ${path} -> ${r.status}\n${text}`);
      }

      // certaines routes renvoient "{}"
      const trimmed = (text || "").trim();
      const json = trimmed ? JSON.parse(trimmed) : null;
      return json;
    }

    // ====== AUTH: SEND OTP ======
    async function sendMagicLink(email) {
      loginBtn.disabled = true;
      setStatus("Envoi du lien…");

      try {
        // GoTrue endpoint direct
        await apiFetch("/auth/v1/otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email,
            create_user: true,
            redirect_to: window.location.origin + window.location.pathname
          })
        });

        setStatus("Lien envoyé. Vérifie ton courriel et clique sur le lien.");
      } catch (e) {
        setStatus("Erreur: " + e.message);
        logDebug("[OTP ERROR]\n" + e.message);
      } finally {
        loginBtn.disabled = false;
      }
    }

    // ====== AUTH: GET USER ======
    async function loadUserEmail() {
      const data = await apiFetch("/auth/v1/user", { method: "GET" });
      userEmailEl.textContent = data?.email || "(email inconnu)";
      authPillEl.textContent = "authenticated";
      return data;
    }

    // ====== DATA: PLAYERS ======
    async function loadPlayers() {
      playersList.innerHTML = "";
      try {
        const rows = await apiFetch("/rest/v1/players?select=id,name,created_at&order=created_at.desc");
        if (!rows || rows.length === 0) {
          playersList.innerHTML = "<li class='muted'>(aucun joueur)</li>";
          return;
        }
        for (const p of rows) {
          const li = document.createElement("li");
          li.textContent = `${p.name} `;
          const small = document.createElement("span");
          small.className = "muted";
          small.textContent = `(${p.id.slice(0,8)})`;
          li.appendChild(small);
          playersList.appendChild(li);
        }
      } catch (e) {
        playersList.innerHTML = "<li class='err'>Erreur chargement joueurs (voir debug)</li>";
        logDebug("[PLAYERS LOAD ERROR]\n" + e.message);
      }
    }

    async function addPlayer(name) {
      try {
        const inserted = await apiFetch("/rest/v1/players?select=id,name,created_at", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Prefer": "return=representation"
          },
          body: JSON.stringify({ name })
        });
        logDebug("[PLAYER INSERT OK]\n" + JSON.stringify(inserted, null, 2));
        await loadPlayers();
      } catch (e) {
        logDebug("[PLAYER INSERT ERROR]\n" + e.message);
        throw e;
      }
    }

    // ====== DATA: MATCHES ======
    async function loadMatches() {
      matchesList.innerHTML = "";
      try {
        const rows = await apiFetch("/rest/v1/matches?select=id,court,status,created_at&order=created_at.desc");
        if (!rows || rows.length === 0) {
          matchesList.innerHTML = "<li class='muted'>(aucun match)</li>";
          return;
        }
        for (const m of rows) {
          const li = document.createElement("li");
          li.textContent = `Terrain ${m.court} — ${m.status} `;
          const small = document.createElement("span");
          small.className = "muted";
          small.textContent = `(${m.id.slice(0,8)})`;
          li.appendChild(small);
          matchesList.appendChild(li);
        }
      } catch (e) {
        matchesList.innerHTML = "<li class='err'>Erreur chargement matchs (voir debug)</li>";
        logDebug("[MATCHES LOAD ERROR]\n" + e.message);
      }
    }

    async function createMatch(court, status) {
      try {
        const inserted = await apiFetch("/rest/v1/matches?select=id,court,status,created_at", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Prefer": "return=representation"
          },
          body: JSON.stringify({ court, status })
        });
        logDebug("[MATCH INSERT OK]\n" + JSON.stringify(inserted, null, 2));
        await loadMatches();
      } catch (e) {
        logDebug("[MATCH INSERT ERROR]\n" + e.message);
        throw e;
      }
    }

    // ====== INIT ======
    (async function init() {
      debugEl.textContent = "";

      // retour magic link
      const hp = parseHashParams();
      if (hp?.error) {
        showLogin(`Erreur auth: ${hp.error}\n${hp.error_description || ""}`);
        history.replaceState(null, "", window.location.pathname + window.location.search);
        return;
      }
      if (hp?.access_token) {
        saveAccessToken(hp.access_token);
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }

      const token = getAccessToken();
      if (!token) {
        showLogin();
        return;
      }

      showApp();
      setAppStatus("Chargement du profil…");

      try {
        await loadUserEmail();
        setAppStatus("Connecté ✓");
        await loadPlayers();
        await loadMatches();
      } catch (e) {
        logDebug("[INIT ERROR]\n" + e.message);
        clearTokens();
        showLogin("Session invalide ou accès refusé. Reconnecte-toi.");
      }
    })();

    // ====== EVENTS ======
    loginBtn.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      if (!email) return alert("Courriel requis");
      await sendMagicLink(email);
    });

    logoutBtn.addEventListener("click", () => {
      clearTokens();
      window.location.href = window.location.origin + window.location.pathname;
    });

    addPlayerBtn.addEventListener("click", async () => {
      const name = playerNameEl.value.trim();
      if (!name) return alert("Nom requis");
      addPlayerBtn.disabled = true;
      try {
        await addPlayer(name);
        playerNameEl.value = "";
      } catch (e) {
        alert("Erreur ajout joueur. Ouvre le debug.");
      } finally {
        addPlayerBtn.disabled = false;
      }
    });

    createMatchBtn.addEventListener("click", async () => {
      const court = Number(courtEl.value);
      const status = statusMatchEl.value;
      if (!Number.isFinite(court) || court <= 0) return alert("Terrain invalide");
      createMatchBtn.disabled = true;
      try {
        await createMatch(court, status);
      } catch (e) {
        alert("Erreur création match. Ouvre le debug.");
      } finally {
        createMatchBtn.disabled = false;
      }
    });

    toggleDebugBtn.addEventListener("click", () => {
      debugEl.classList.toggle("hidden");
    });
  </script>
</body>
</html>
