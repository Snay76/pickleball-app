<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pickleball – Test OTP</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
    }
    label { display: block; margin-top: 12px; }
    input, button { padding: 8px; margin-top: 6px; }
    button { cursor: pointer; }
    #status { margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h1>Pickleball</h1>
  <p style="color:red;font-weight:bold">VERSION TEST OTP 2026-01-21-001</p>

  <h2>Connexion (test OTP direct)</h2>

  <label for="email">Courriel</label>
  <input
    id="email"
    type="email"
    placeholder="nom@exemple.com"
    autocomplete="email"
    required
  />

  <br />
  <button id="loginBtn" type="button">Recevoir un lien</button>

  <p id="status" aria-live="polite"></p>

  <script>
    // ================= CONFIG =================
    const SUPABASE_URL = "https://cehqaxtcfmgjajmmcccz.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlaHFheHRjZm1namFqbW1jY2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NTQ1OTUsImV4cCI6MjA4NDUzMDU5NX0.U0IiTLx1_Vd4D8WBkhkO8KOrl3w_ftbPtcIWs_n1KmA";

    // ================= DOM =================
    const emailEl = document.getElementById("email");
    const btnEl = document.getElementById("loginBtn");
    const statusEl = document.getElementById("status");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    // ================= TEST OTP DIRECT =================
    async function testOtpFromPage() {
      const email = emailEl.value.trim();
      if (!email) {
        alert("Courriel requis");
        return;
      }

      btnEl.disabled = true;
      setStatus("Envoi du lien (test direct)…");

      try {
        const response = await fetch(`${SUPABASE_URL}/auth/v1/otp`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            email: email,
            create_user: true,
            redirect_to: "https://pickleball-ccyp.pages.dev"
          })
        });

        const text = await response.text();

        console.log("OTP RESULT:", response.status, text);

        if (!response.ok) {
          setStatus(`ERREUR ${response.status}\n${text}`);
        } else {
          setStatus("✔ Lien envoyé.\nVérifie ton courriel et clique sur le lien.");
        }

      } catch (err) {
        console.error("OTP FETCH ERROR:", err);
        setStatus("❌ ERREUR FETCH : " + err.message);
      } finally {
        btnEl.disabled = false;
      }
    }

    // ================= HANDLER BOUTON =================
    btnEl.addEventListener("click", testOtpFromPage);
  </script>
</body>
</html>
