<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pickleball</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 24px; }
    .hidden { display:none; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 16px 0; max-width: 900px; }
    label { display:block; margin-top: 10px; font-weight: 600; }
    input, select { padding: 8px; width: min(480px, 100%); }
    button { padding: 8px 12px; margin-top: 10px; cursor: pointer; }
    #status, #appStatus { white-space: pre-wrap; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .row > div { min-width: 220px; flex: 1; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <p style="color:red;font-weight:bold">VERSION APP 2026-01-21-PLAYERS+GAMES</p>

  <h1>Pickleball</h1>

  <!-- LOGIN -->
  <div id="loginSection" class="card">
    <h2>Connexion</h2>
    <label for="email">Courriel</label>
    <input id="email" type="email" placeholder="nom@exemple.com" autocomplete="email" required />
    <button id="loginBtn" type="button">Recevoir un lien</button>
    <p id="status" aria-live="polite"></p>
  </div>

  <!-- APP -->
  <div id="appSection" class="card hidden">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div>
        <h2>Application</h2>
        <div>Connecté : <strong id="userEmail">(…)</strong> <span id="authPill" class="pill">auth</span></div>
      </div>
      <div style="text-align:right;">
        <button id="logoutBtn" type="button">Se déconnecter</button>
      </div>
    </div>

    <p id="appStatus"></p>

    <hr />

    <!-- ADD PLAYER -->
    <h3>Ajouter un joueur</h3>
    <div class="row">
      <div>
        <label for="pname">Nom affiché</label>
        <input id="pname" type="text" placeholder="Ex: Yann" />
      </div>
      <div>
        <label for="pemail">Email (optionnel)</label>
        <input id="pemail" type="email" placeholder="nom@exemple.com" />
      </div>
    </div>
    <button id="addPlayerBtn" type="button">Ajouter</button>

    <hr />

    <!-- CREATE GAME -->
    <h3>Créer un match</h3>
    <div class="row">
      <div>
        <label for="court">Court</label>
        <input id="court" type="number" min="1" value="1" />
      </div>
      <div>
        <label for="roundId">Round ID (optionnel)</label>
        <input id="roundId" type="text" placeholder="uuid ou vide" />
      </div>
      <div>
        <label for="statusGame">Statut</label>
        <select id="statusGame">
          <option value="open">open</option>
          <option value="playing">playing</option>
          <option value="done">done</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="a1">Équipe A - joueur 1 (a1)</label>
        <select id="a1"></select>
      </div>
      <div>
        <label for="a2">Équipe A - joueur 2 (a2)</label>
        <select id="a2"></select>
      </div>
      <div>
        <label for="b1">Équipe B - joueur 1 (b1)</label>
        <select id="b1"></select>
      </div>
      <div>
        <label for="b2">Équipe B - joueur 2 (b2)</label>
        <select id="b2"></select>
      </div>
    </div>

    <button id="createGameBtn" type="button">Créer le match</button>

    <hr />

    <!-- LIST GAMES -->
    <h3>Matchs</h3>
    <button id="refreshBtn" type="button">Rafraîchir</button>

    <table>
      <thead>
        <tr>
          <th>Créé</th>
          <th>Court</th>
          <th>Équipe A</th>
          <th>Équipe B</th>
          <th>Statut</th>
          <th>Score final</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="gamesTbody"></tbody>
    </table>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://cehqaxtcfmgjajmmcccz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlaHFheHRjZm1namFqbW1jY2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NTQ1OTUsImV4cCI6MjA4NDUzMDU5NX0.U0IiTLx1_Vd4D8WBkhkO8KOrl3w_ftbPtcIWs_n1KmA"; // <- garde ta clé anon ici

    // Tables (adapte si tu n'as pas ces noms exacts)
    const T_PLAYERS = "players";
    const T_GAMES   = "games";

    // ====== DOM ======
    const loginSection = document.getElementById("loginSection");
    const appSection   = document.getElementById("appSection");
    const statusEl     = document.getElementById("status");
    const appStatusEl  = document.getElementById("appStatus");
    const emailEl      = document.getElementById("email");
    const loginBtn     = document.getElementById("loginBtn");
    const logoutBtn    = document.getElementById("logoutBtn");
    const userEmailEl  = document.getElementById("userEmail");
    const authPill     = document.getElementById("authPill");

    const pnameEl      = document.getElementById("pname");
    const pemailEl     = document.getElementById("pemail");
    const addPlayerBtn = document.getElementById("addPlayerBtn");

    const courtEl      = document.getElementById("court");
    const roundIdEl    = document.getElementById("roundId");
    const statusGameEl = document.getElementById("statusGame");
    const a1El         = document.getElementById("a1");
    const a2El         = document.getElementById("a2");
    const b1El         = document.getElementById("b1");
    const b2El         = document.getElementById("b2");
    const createGameBtn= document.getElementById("createGameBtn");

    const refreshBtn   = document.getElementById("refreshBtn");
    const gamesTbody   = document.getElementById("gamesTbody");

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setAppStatus(msg) { appStatusEl.textContent = msg || ""; }

    function showLogin(msg) {
      appSection.classList.add("hidden");
      loginSection.classList.remove("hidden");
      if (msg) setStatus(msg);
    }
    function showApp() {
      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      setStatus("");
    }

    // ====== Local Storage token ======
    const LS_ACCESS = "pb_access_token";
    function saveAccessToken(token) { localStorage.setItem(LS_ACCESS, token); }
    function getAccessToken() { return localStorage.getItem(LS_ACCESS); }
    function clearTokens() { localStorage.removeItem(LS_ACCESS); }

    function parseHashParams() {
      const hash = window.location.hash?.startsWith("#") ? window.location.hash.slice(1) : "";
      if (!hash) return null;
      const params = new URLSearchParams(hash);
      return {
        access_token: params.get("access_token"),
        error: params.get("error"),
        error_description: params.get("error_description"),
      };
    }

    async function fetchUser(accessToken) {
      const r = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${accessToken}`
        }
      });
      const text = await r.text();
      if (!r.ok) throw new Error(`USER ${r.status}: ${text}`);
      return JSON.parse(text);
    }

    // ====== Minimal PostgREST helper ======
    async function sbSelect(table, select, accessToken) {
      const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${encodeURIComponent(select)}`, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${accessToken}`,
          Accept: "application/json"
        }
      });
      const text = await r.text();
      if (!r.ok) throw new Error(`SELECT ${table} ${r.status}: ${text}`);
      return JSON.parse(text || "[]");
    }

    async function sbInsert(table, row, accessToken) {
      const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        method: "POST",
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
          Prefer: "return=representation"
        },
        body: JSON.stringify(row)
      });
      const text = await r.text();
      if (!r.ok) throw new Error(`INSERT ${table} ${r.status}: ${text}`);
      return JSON.parse(text || "[]");
    }

    async function sbPatch(table, matchId, patch, accessToken) {
      const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${matchId}`, {
        method: "PATCH",
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
          Prefer: "return=representation"
        },
        body: JSON.stringify(patch)
      });
      const text = await r.text();
      if (!r.ok) throw new Error(`PATCH ${table} ${r.status}: ${text}`);
      return JSON.parse(text || "[]");
    }

    // ====== OTP ======
    async function sendMagicLink(email) {
      loginBtn.disabled = true;
      setStatus("Envoi du lien…");

      try {
        const r = await fetch(`${SUPABASE_URL}/auth/v1/otp`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            email,
            create_user: true,
            redirect_to: "https://pickleball-ccyp.pages.dev"
          })
        });

        const text = await r.text();
        if (!r.ok) {
          setStatus(`Erreur (${r.status}): ${text}`);
          return;
        }
        setStatus("Lien envoyé. Vérifie ton courriel et clique le lien.");
      } catch (e) {
        console.error(e);
        setStatus("Erreur: Load failed");
      } finally {
        loginBtn.disabled = false;
      }
    }

    // ====== UI helpers ======
    function fillSelect(selectEl, items, placeholder="— choisir —") {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);

      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.display_name + (it.email ? ` (${it.email})` : "");
        selectEl.appendChild(opt);
      }
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString("fr-CA"); } catch { return iso || ""; }
    }

    // ====== App logic ======
    let ACCESS = null;
    let PLAYERS = [];

    async function loadPlayers() {
      PLAYERS = await sbSelect(T_PLAYERS, "id,display_name,email,created_at", ACCESS);
      // tri alpha
      PLAYERS.sort((a,b) => (a.display_name||"").localeCompare(b.display_name||""));
      fillSelect(a1El, PLAYERS);
      fillSelect(a2El, PLAYERS);
      fillSelect(b1El, PLAYERS);
      fillSelect(b2El, PLAYERS);
    }

    function playerNameById(id) {
      const p = PLAYERS.find(x => x.id === id);
      return p ? p.display_name : "(inconnu)";
    }

    async function loadGames() {
      const games = await sbSelect(T_GAMES, "id,created_at,court,a1,a2,b1,b2,status,final_score_a,final_score_b", ACCESS);
      // plus récent en haut
      games.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

      gamesTbody.innerHTML = "";
      for (const g of games) {
        const tr = document.createElement("tr");

        const aNames = [playerNameById(g.a1), playerNameById(g.a2)].join(" + ");
        const bNames = [playerNameById(g.b1), playerNameById(g.b2)].join(" + ");

        tr.innerHTML = `
          <td>${fmtDate(g.created_at)}</td>
          <td>${g.court ?? ""}</td>
          <td>${aNames}</td>
          <td>${bNames}</td>
          <td>${g.status ?? ""}</td>
          <td>${(g.final_score_a ?? "")} - ${(g.final_score_b ?? "")}</td>
          <td></td>
        `;

        const tdAction = tr.querySelector("td:last-child");

        // mini UI pour finaliser score
        const sA = document.createElement("input");
        sA.type = "number"; sA.min = "0"; sA.style.width = "70px"; sA.placeholder = "A";
        const sB = document.createElement("input");
        sB.type = "number"; sB.min = "0"; sB.style.width = "70px"; sB.placeholder = "B";
        const btn = document.createElement("button");
        btn.textContent = "Sauver score";
        btn.addEventListener("click", async () => {
          try {
            const finalA = sA.value === "" ? null : Number(sA.value);
            const finalB = sB.value === "" ? null : Number(sB.value);
            await sbPatch(T_GAMES, g.id, { final_score_a: finalA, final_score_b: finalB, status: "done" }, ACCESS);
            setAppStatus("Score sauvé ✔");
            await loadGames();
          } catch (e) {
            console.error(e);
            setAppStatus("Erreur score: " + e.message);
          }
        });

        tdAction.appendChild(sA);
        tdAction.appendChild(document.createTextNode(" "));
        tdAction.appendChild(sB);
        tdAction.appendChild(document.createTextNode(" "));
        tdAction.appendChild(btn);

        gamesTbody.appendChild(tr);
      }
    }

    async function bootstrapApp() {
      showApp();
      setAppStatus("Chargement…");
      const me = await fetchUser(ACCESS);
      userEmailEl.textContent = me?.email || "(email)";
      authPill.textContent = "auth OK";

      await loadPlayers();
      await loadGames();
      setAppStatus("Prêt ✔");
    }

    // ====== INIT ======
    (async function init() {
      const hp = parseHashParams();
      if (hp?.error) {
        showLogin(`Erreur auth: ${hp.error}\n${hp.error_description || ""}`);
        history.replaceState(null, "", window.location.pathname + window.location.search);
        return;
      }
      if (hp?.access_token) {
        saveAccessToken(hp.access_token);
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }

      ACCESS = getAccessToken();
      if (!ACCESS) {
        showLogin();
        return;
      }

      try {
        await bootstrapApp();
      } catch (e) {
        console.error(e);
        clearTokens();
        showLogin("Session invalide ou RLS bloque. Reconnecte-toi.");
      }
    })();

    // ====== EVENTS ======
    loginBtn.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      if (!email) return alert("Courriel requis");
      await sendMagicLink(email);
    });

    logoutBtn.addEventListener("click", () => {
      clearTokens();
      window.location.href = window.location.origin + window.location.pathname;
    });

    addPlayerBtn.addEventListener("click", async () => {
      const name = (pnameEl.value || "").trim();
      const em   = (pemailEl.value || "").trim() || null;
      if (!name) return alert("Nom requis");

      try {
        setAppStatus("Ajout joueur…");
        await sbInsert(T_PLAYERS, { display_name: name, email: em }, ACCESS);
        pnameEl.value = ""; pemailEl.value = "";
        await loadPlayers();
        setAppStatus("Joueur ajouté ✔");
      } catch (e) {
        console.error(e);
        setAppStatus("Erreur joueur: " + e.message);
      }
    });

    createGameBtn.addEventListener("click", async () => {
      const court = Number(courtEl.value || 1);
      const round_id = (roundIdEl.value || "").trim() || null;
      const a1 = a1El.value, a2 = a2El.value, b1 = b1El.value, b2 = b2El.value;
      const status = statusGameEl.value;

      if (!a1 || !a2 || !b1 || !b2) return alert("Choisis 4 joueurs");
      if (new Set([a1,a2,b1,b2]).size !== 4) return alert("Un joueur est choisi 2 fois");

      try {
        setAppStatus("Création match…");
        await sbInsert(T_GAMES, {
          court,
          round_id,
          a1, a2, b1, b2,
          status,
          final_score_a: null,
          final_score_b: null
        }, ACCESS);

        setAppStatus("Match créé ✔");
        await loadGames();
      } catch (e) {
        console.error(e);
        setAppStatus("Erreur match: " + e.message);
      }
    });

    refreshBtn.addEventListener("click", async () => {
      try { await loadPlayers(); await loadGames(); }
      catch (e) { console.error(e); setAppStatus("Erreur refresh: " + e.message); }
    });
  </script>
</body>
</html>
